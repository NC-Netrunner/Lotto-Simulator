<!DOCTYPE html>
<html>
<head>
    <title>The 28-Heads Speedrun</title>
    <style>
        :root { --neon: #00ff41; --gold: #ffd700; --bg: #050505; --panel: #111; }
        body { background: var(--bg); color: white; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        #container { background: var(--panel); border: 2px solid #333; padding: 30px; border-radius: 15px; text-align: center; width: 420px; box-shadow: 0 0 40px rgba(0,255,65,0.1); }
        .label { color: var(--neon); font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; }
        .big-number { font-size: 4.5rem; font-weight: bold; margin: 10px 0; text-shadow: 0 0 15px var(--neon); }
        
        #coin-viz { width: 70px; height: 70px; border-radius: 50%; margin: 15px auto; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; border: 4px solid #444; }
        .heads { background: var(--gold); color: #000; border-color: #b8860b; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .tails { background: #222; color: #555; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; text-align: left; border-top: 1px solid #333; padding-top: 15px; }
        .stat-val { font-size: 1.1rem; color: #fff; display: block; margin-top: 5px; }

        #log { margin-top: 20px; height: 130px; background: #000; border: 1px solid #222; padding: 10px; font-size: 0.75rem; overflow-y: auto; text-align: left; color: #888; border-radius: 5px; }
        .log-entry { border-bottom: 1px solid #111; padding: 4px 0; }
        .log-error { color: #ff4444; font-weight: bold; }
        .log-new-record { color: var(--gold); font-weight: bold; }

        .controls { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
        button { background: transparent; border: 2px solid var(--neon); color: var(--neon); padding: 12px; cursor: pointer; font-family: inherit; font-weight: bold; transition: 0.2s; border-radius: 5px; }
        button:hover { background: var(--neon); color: black; }
        button.active { background: #ff4444; border-color: #ff4444; color: white; }
        
        .toggle-container { font-size: 0.85rem; color: #aaa; display: flex; justify-content: center; align-items: center; gap: 8px; }
    </style>
</head>
<body>

    <div id="container">
        <div class="label">Current Run Streak</div>
        <div id="streak" class="big-number">0</div>
        <div id="coin-viz" class="tails">-</div>

        <div class="stats-grid">
            <div><span class="label">Fastest Win</span><span id="fastest-win" class="stat-val" style="color: var(--gold)">N/A</span></div>
            <div><span class="label">Current Flips</span><span id="total-flips" class="stat-val">0</span></div>
        </div>

        <div style="margin-top: 20px;">
            <span class="label">Run Time Equivalent</span>
            <div id="time-elapsed" style="font-size: 1.3rem; color: #ff4444; margin-top: 5px;">0 Years</div>
        </div>

        <div id="log"></div>

        <div class="controls">
            <button id="startBtn" onclick="toggleEngine()">START NEW RUN</button>
            <div class="toggle-container">
                <input type="checkbox" id="fastMode" onchange="updateSpeed()"> 
                <label for="fastMode">ENGAGE BACKGROUND WORKER (Max CPU)</label>
            </div>
            <button onclick="resetHighscore()" style="border-color: #444; color: #444; font-size: 0.6rem; padding: 6px;">CLEAR FASTEST WIN</button>
        </div>
    </div>

    <script id="worker-code" type="javascript/worker">
        let running = false;
        let isFast = false;
        let streak = 0;
        let total = 0;
        let highestStreakThisRun = 0;
        
        const bufferSize = 65536; 
        const buffer = new Uint8Array(bufferSize);

        self.onmessage = function(e) {
            const data = e.data;
            if (data.cmd === 'start') {
                running = true;
                isFast = data.isFast;
                total = 0; 
                streak = 0;
                highestStreakThisRun = 0;
                processLoop();
            } else if (data.cmd === 'stop') {
                running = false;
            } else if (data.cmd === 'speed') {
                isFast = data.isFast;
            }
        };

        function processLoop() {
            if (!running) return;

            if (isFast) {
                let chunkEndTime = Date.now() + 50; 
                let logMilestone = 0;

                while (running && Date.now() < chunkEndTime) {
                    self.crypto.getRandomValues(buffer); // Explicitly use self.crypto
                    for (let i = 0; i < bufferSize; i++) {
                        total++;
                        if (buffer[i] % 2 === 0) { 
                            streak++;
                            if (streak > highestStreakThisRun) {
                                highestStreakThisRun = streak;
                                if (streak >= 15 && streak % 2 === 0) {
                                    logMilestone = streak;
                                }
                            }
                        } else {
                            streak = 0;
                        }
                        
                        if (streak === 28) {
                            self.postMessage({ type: 'win', total, streak });
                            return;
                        }
                    }
                }
                
                self.postMessage({ type: 'update', total, streak, logMilestone });
                setTimeout(processLoop, 0); 
                
            } else {
                let singleByte = new Uint8Array(1);
                self.crypto.getRandomValues(singleByte);
                total++;
                
                if (singleByte[0] % 2 === 0) {
                    streak++;
                } else {
                    streak = 0;
                }

                if (streak === 28) {
                    self.postMessage({ type: 'win', total, streak });
                    return;
                }

                self.postMessage({ type: 'update', total, streak, logMilestone: 0 });
                setTimeout(processLoop, 150); 
            }
        }
    </script>

    <script>
        // Safely declare globals
        let fastestFlips = Infinity;
        let uiTotal = 0;
        let uiLogs = [];
        let engineRunning = false;
        const logBox = document.getElementById('log');

        // Global error catcher - prints JS crashes directly to the UI box
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            addLog(`SYS ERROR: ${msg}`, false, true);
            return false;
        };

        // Safely load local storage data (prevents crashes from old save data)
        try {
            const storedFastest = localStorage.getItem('fastestFlips');
            if (storedFastest) {
                let parsed = parseInt(storedFastest);
                if (!isNaN(parsed) && parsed > 0) fastestFlips = parsed;
            }

            const storedLogs = localStorage.getItem('logs');
            if (storedLogs) {
                let parsedLogs = JSON.parse(storedLogs);
                if (Array.isArray(parsedLogs)) uiLogs = parsedLogs;
            }
        } catch (e) {
            addLog("Storage reset due to format update.", false, true);
            uiLogs = [];
        }

        // Initialize Web Worker
        const blob = new Blob([document.getElementById('worker-code').textContent], { type: "text/javascript" });
        const worker = new Worker(window.URL.createObjectURL(blob));

        // Initial UI Render
        updateDOM(0, 0);
        
        if (uiLogs.length === 0) addLog("Ready for a new speedrun.");
        uiLogs.forEach(msg => {
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerText = msg;
            logBox.appendChild(div);
        });

        // Handle messages back from the Worker
        worker.onmessage = function(e) {
            const data = e.data;
            uiTotal = data.total;

            updateDOM(data.total, data.streak);

            if (data.logMilestone > 0) {
                addLog(`Close call: Hit ${data.logMilestone} Heads...`);
            }

            if (data.type === 'win') {
                engineRunning = false;
                document.getElementById('startBtn').innerText = "START NEW RUN";
                document.getElementById('startBtn').className = "";
                
                let runYears = (data.total * 10 / 31557600).toFixed(2);
                
                if (data.total < fastestFlips) {
                    fastestFlips = data.total;
                    localStorage.setItem('fastestFlips', fastestFlips);
                    addLog(`ðŸ† NEW RECORD WIN! Took ${runYears} Years!`, true);
                    alert(`INCREDIBLE SPEEDRUN!\nYou hit 28 heads in ${runYears} simulated years.\nThis is a new record!`);
                } else {
                    addLog(`Win achieved in ${runYears} Years.`);
                    alert(`Run complete! You hit 28 heads in ${runYears} simulated years.`);
                }
                updateDOM(data.total, 28);
            }
        };

        function updateDOM(total, streak) {
            document.getElementById('streak').innerText = streak;
            document.getElementById('total-flips').innerText = total.toLocaleString();
            
            if (fastestFlips !== Infinity) {
                let fastYears = (fastestFlips * 10 / 31557600).toFixed(3);
                document.getElementById('fastest-win').innerText = `${fastYears} Years`;
            } else {
                document.getElementById('fastest-win').innerText = "N/A";
            }

            let currentYears = (total * 10 / 31557600).toFixed(4);
            document.getElementById('time-elapsed').innerText = `${currentYears} Years`;

            const viz = document.getElementById('coin-viz');
            if (streak > 0) {
                viz.innerText = "H";
                viz.className = "heads";
            } else {
                viz.innerText = "T";
                viz.className = "tails";
            }
        }

        function addLog(msg, isRecord = false, isError = false) {
            const div = document.createElement('div');
            div.className = "log-entry";
            if (isRecord) div.className += " log-new-record";
            if (isError) div.className += " log-error";
            
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logBox.prepend(div);

            // We don't save errors to long-term storage
            if (!isError) {
                uiLogs.unshift(div.innerText);
                if (uiLogs.length > 20) uiLogs.pop();
                localStorage.setItem('logs', JSON.stringify(uiLogs));
            }
        }

        function toggleEngine() {
            if (engineRunning) {
                engineRunning = false;
                worker.postMessage({ cmd: 'stop' });
                document.getElementById('startBtn').innerText = "START NEW RUN";
                document.getElementById('startBtn').className = "";
                addLog("Run aborted.");
                return;
            }

            engineRunning = true;
            uiTotal = 0;
            updateDOM(0, 0);
            
            const btn = document.getElementById('startBtn');
            btn.innerText = "HALT RUN";
            btn.className = "active";
            
            addLog("New speedrun started...");
            
            worker.postMessage({
                cmd: 'start',
                isFast: document.getElementById('fastMode').checked
            });
        }

        function updateSpeed() {
            worker.postMessage({
                cmd: 'speed',
                isFast: document.getElementById('fastMode').checked
            });
        }

        function resetHighscore() {
            if(confirm("Are you sure you want to delete your fastest win record?")) {
                localStorage.removeItem('fastestFlips');
                fastestFlips = Infinity;
                updateDOM(uiTotal, parseInt(document.getElementById('streak').innerText));
                addLog("Fastest win record cleared.");
            }
        }
    </script>
</body>
</html>
